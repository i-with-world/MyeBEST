###############################################################################
#                                                                             #
#                                                       30/Oct/2014  20:23:26 #
# IAR ANSI C/C++ Compiler V6.30.6.23336/W32 EVALUATION for ARM                #
# Copyright 1999-2012 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\SD_System\ #
#                    SD_driver.c                                              #
#    Command line =  E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\SD_System\ #
#                    SD_driver.c -D IAR -lCN E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³Ì #
#                    Ðò\1029µ÷ÊÔ°æ\RAM_128K\List\ -lB                         #
#                    E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\RAM_128K\L #
#                    ist\ -o E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\RA #
#                    M_128K\Obj\ --debug --endian=little --cpu=Cortex-M4 -e   #
#                    --fpu=None --dlib_config "C:\Program Files\IAR           #
#                    Systems\Embedded Workbench 6.0                           #
#                    Evaluation\arm\INC\c\DLib_Config_Normal.h" -I            #
#                    E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\Library\CP #
#                    U\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\Libr #
#                    ary\Drivers\ADC\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1 #
#                    029µ÷ÊÔ°æ\Library\Drivers\FTM\ -I                        #
#                    E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\Library\Dr #
#                    ivers\GPIO\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ #
#                    ÊÔ°æ\Library\Drivers\PIT\ -I                             #
#                    E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\System_Ini #
#                    t\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\Sour #
#                    ce\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\OLE #
#                    D\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\SD_S #
#                    ystem\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\ #
#                    Simple_AD\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷Ê #
#                    Ô°æ\Delay\ -I E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷Ê #
#                    Ô°æ\Make_Desicion\ -Oh                                   #
#    List file    =  E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\RAM_128K\L #
#                    ist\SD_driver.lst                                        #
#    Object file  =  E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\RAM_128K\O #
#                    bj\SD_driver.o                                           #
#                                                                             #
#                                                                             #
###############################################################################

E:\´´ÐÂ»î¶¯\ÖÇÄÜ³µ\µÚÊ®½ì\±¾³µ³ÌÐò\1029µ÷ÊÔ°æ\SD_System\SD_driver.c
      1          /******************************************************************************
      2          
      3          * SD_driver.c
      4          
      5          * sd¿¨µÄµ×²ãÇý¶¯ÎÄ¼þ   
      6          
      7          * µÚÒ»×÷Õß£º  ¼Í³É   (µÚËÄ½ìÉãÏñÍ·)
      8            ÍêÉÆÓëÕûÀí£ºËïÎÄ½¡ (µÚÁù½ìÉãÏñÍ·)
      9          * °æ±¾£ºV1.15 (ÓëV1.13¡¢v1.14°æÏà¼æÈÝ,²»Ê¹ÄÜË«»º´æÊ±ÓëV1.10Ö®ºóµÄ°æ±¾Ïà¼æÈÝ)
     10          * °æ±¾¸üÐÂÊ±¼ä£º2012Äê1ÔÂ30ÈÕ
     11            
     12          * Ö÷¿ØÐ¾Æ¬£ºMK10N512VMD100
     13            ¿ª·¢Æ½Ì¨£ºCodeWarrior 10.1
     14          
     15          * (!!!¸ü¸ÄÓ²¼þÆ½Ì¨ºó±ØÐëÐÞ¸Ä!!!)                
     16           
     17          ******************************************************************************/
     18          
     19          #include "./SD_System.h"
     20                                            
     21          #ifdef EN_SD                  
     22           

   \                                 In section .bss, align 4
     23          byte_sd sd_initover = 0; /* SD¿¨³õÊ¼»¯½áÊø±êÖ¾ */
     24          
     25          byte_sd sd_yes=0;  //ÅÐ¶ÏÊÇ·ñÓÃSD¿¨(Ã»ÓÐÎª0£¬ÓÐÎª1)
     26          byte_sd flag_sdhc; //sdhc¿¨±êÖ¾,=1ÓÐÐ§         /************By Sword************/ 
     27          byte_sd flag_test_sd; //µ÷ÊÔÊ¹ÓÃ               /************By Sword************/ 
     28          byte_sd flag_err_sd;  //SD³ö´í±êÖ¾             /************By Sword************/ 
     29          byte_sd Flag_SDRdy;    //SD¿¨¾ÍÐ÷±êÖ¾(=1±íSD¿¨¾ÍÐ÷)
     30          
     31          /*ÄÚ²¿±äÁ¿*/
     32          static byte_sd resp_sd[4];                     /************By Sword************/ 
   \                     resp_sd:
   \   00000000                      DS8 4
   \                     sd_initover:
   \   00000004                      DS8 1
   \                     flag_sdhc:
   \   00000005                      DS8 1
   \                     flag_err_sd:
   \   00000006                      DS8 1
   \                     Flag_SDRdy:
   \   00000007                      DS8 1

   \                                 In section .bss, align 1
   \                     sd_yes:
   \   00000000                      DS8 1

   \                                 In section .bss, align 1
   \                     flag_test_sd:
   \   00000000                      DS8 1
     33          
     34          /**************************ÄÚ²¿º¯Êý¶¨Òå**************************/
     35          #if DELAY_WaitRead_SD != 0
     36          /**********************************************************
     37          * function:SD_Delay_ReadByte
     38          * description:¶ÁÈ¡1ByteÊý¾ÝÖ®ºóµÄÑÓÊ±,ÑÓÊ±Ê±¼äÔÚSD_driver.h
     39          *             ÖÐ¶¨Òå¡£
     40          **********************************************************/

   \                                 In section .text, align 4, keep-with-next
     41          static void SD_Delay_ReadByte(void)
     42          {
     43          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \                     SD_Delay_ReadByte:
   \   00000000   0xBF00             nop              
   \   00000002   0xBF00             nop              
   \   00000004   0xBF00             nop              
   \   00000006   0xBF00             nop              
   \   00000008   0xBF00             nop              
     44          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   0000000A   0xBF00             nop              
   \   0000000C   0xBF00             nop              
   \   0000000E   0xBF00             nop              
   \   00000010   0xBF00             nop              
   \   00000012   0xBF00             nop              
     45          
     46          #if DELAY_WaitRead_SD > 1
     47          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   00000014   0xBF00             nop              
   \   00000016   0xBF00             nop              
   \   00000018   0xBF00             nop              
   \   0000001A   0xBF00             nop              
   \   0000001C   0xBF00             nop              
     48          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   0000001E   0xBF00             nop              
   \   00000020   0xBF00             nop              
   \   00000022   0xBF00             nop              
   \   00000024   0xBF00             nop              
   \   00000026   0xBF00             nop              
     49          #endif
     50          	
     51          #if DELAY_WaitRead_SD > 2
     52          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   00000028   0xBF00             nop              
   \   0000002A   0xBF00             nop              
   \   0000002C   0xBF00             nop              
   \   0000002E   0xBF00             nop              
   \   00000030   0xBF00             nop              
     53          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   00000032   0xBF00             nop              
   \   00000034   0xBF00             nop              
   \   00000036   0xBF00             nop              
   \   00000038   0xBF00             nop              
   \   0000003A   0xBF00             nop              
     54          #endif
     55          	
     56          #if DELAY_WaitRead_SD > 3
     57          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   0000003C   0xBF00             nop              
   \   0000003E   0xBF00             nop              
   \   00000040   0xBF00             nop              
   \   00000042   0xBF00             nop              
   \   00000044   0xBF00             nop              
     58          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   00000046   0xBF00             nop              
   \   00000048   0xBF00             nop              
   \   0000004A   0xBF00             nop              
   \   0000004C   0xBF00             nop              
   \   0000004E   0xBF00             nop              
     59          #endif
     60          	
     61          #if DELAY_WaitRead_SD > 4
     62          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   00000050   0xBF00             nop              
   \   00000052   0xBF00             nop              
   \   00000054   0xBF00             nop              
   \   00000056   0xBF00             nop              
   \   00000058   0xBF00             nop              
     63          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
   \   0000005A   0xBF00             nop              
   \   0000005C   0xBF00             nop              
   \   0000005E   0xBF00             nop              
   \   00000060   0xBF00             nop              
   \   00000062   0xBF00             nop              
     64          #endif
     65          	
     66          #if DELAY_WaitRead_SD > 5
     67          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     68          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     69          #endif	
     70          
     71          #if DELAY_WaitRead_SD > 6
     72          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     73          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     74          #endif
     75          	
     76          #if DELAY_WaitRead_SD > 7
     77          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     78          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     79          #endif
     80          	
     81          #if DELAY_WaitRead_SD > 8
     82          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     83          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     84          #endif
     85          	
     86          #if DELAY_WaitRead_SD > 9
     87          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     88          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     89          #endif
     90          	
     91          #if DELAY_WaitRead_SD > 10
     92          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     93          	asm("nop");asm("nop");asm("nop");asm("nop");asm("nop");
     94          #endif	
     95          }
   \   00000064   0x4770             BX       LR               ;; return
     96          #endif
     97          /**********************************************************
     98          * function:SD_WriteByte
     99          * description:Ð´Èë1ByteÊý¾Ý£¨²éÑ¯·½Ê½£©
    100          **********************************************************/

   \                                 In section .text, align 2, keep-with-next
    101          static void SD_WriteByte(byte_sd jc_data) 
    102          {	
    103          	SPI1_SR |= SPI_SR_EOQF_MASK;
   \                     SD_WriteByte:
   \   00000000   0x.... 0x....      LDR.W    R1,??DataTable11  ;; 0x4002d000
    104          	SPI1_MCR &= (~SPI_MCR_HALT_MASK) & (~SPI_MCR_MDIS_MASK);   /* ½øÈëRUNNING×´Ì¬ */
   \   00000004   0x.... 0x....      LDR.W    R3,??DataTable11_1  ;; 0xffffbffe
   \   00000008   0x6ACA             LDR      R2,[R1, #+44]
    105          	
    106          	SPI1_PUSHR = SPI_PUSHR_CTAS(0) | SPI_PUSHR_EOQ_MASK | SPI_PUSHR_CTCNT_MASK | jc_data;
   \   0000000A   0xF040 0x6040      ORR      R0,R0,#0xC000000
   \   0000000E   0xF042 0x5280      ORR      R2,R2,#0x10000000
   \   00000012   0x62CA             STR      R2,[R1, #+44]
   \   00000014   0x680A             LDR      R2,[R1, #+0]
   \   00000016   0x401A             ANDS     R2,R3,R2
   \   00000018   0x600A             STR      R2,[R1, #+0]
   \   0000001A   0x6348             STR      R0,[R1, #+52]
    107          	                                                           /* Ð´ÈëÊý¾Ý²¢Çå¿Õ¼ÆÊý¼Ä´æÆ÷ */ 
    108          	                                                           /* ÖÃÎ»EOQ±íÊ¾¸ÃÊý¾ÝÊÇ¶ÓÁÐÖÐ×îºóÒ»¸ö,¼´Ê¹ÄÜ·¢ËÍ */
    109          	
    110          	while((SPI1_SR & SPI_SR_TCF_MASK) == 0);	
   \                     ??SD_WriteByte_0:
   \   0000001C   0x6AC8             LDR      R0,[R1, #+44]
   \   0000001E   0x2800             CMP      R0,#+0
   \   00000020   0xD5FC             BPL.N    ??SD_WriteByte_0
    111          	SPI1_SR |= SPI_SR_TCF_MASK;
   \   00000022   0x6AC8             LDR      R0,[R1, #+44]
   \   00000024   0xF040 0x4000      ORR      R0,R0,#0x80000000
   \   00000028   0x62C8             STR      R0,[R1, #+44]
    112          	
    113          	SPI1_MCR |= SPI_MCR_CLR_TXF_MASK | SPI_MCR_CLR_RXF_MASK;   /* Çå¿Õ¶ÓÁÐ(Õâ¾äºÜÖØÒª) */
   \   0000002A   0x6808             LDR      R0,[R1, #+0]
   \   0000002C   0xF440 0x6040      ORR      R0,R0,#0xC00
   \   00000030   0x6008             STR      R0,[R1, #+0]
    114          }
   \   00000032   0x4770             BX       LR               ;; return
    115          /**********************************************************
    116          * function:SD_ReadByte
    117          * description:¶Á³ö1ByteÊý¾Ý£¨²éÑ¯·½Ê½£©
    118          **********************************************************/

   \                                 In section .text, align 2, keep-with-next
    119          static byte_sd SD_ReadByte(byte_sd jc_data)
    120          {	
   \                     SD_ReadByte:
   \   00000000   0xB510             PUSH     {R4,LR}
    121          	byte_sd dat;
    122          	
    123          	SPI1_SR |= SPI_SR_EOQF_MASK;
   \   00000002   0x.... 0x....      LDR.W    R4,??DataTable11  ;; 0x4002d000
    124          	SPI1_MCR &= (~SPI_MCR_HALT_MASK) & (~SPI_MCR_MDIS_MASK);   /* ½øÈëRUNNING×´Ì¬ */
   \   00000006   0x.... 0x....      LDR.W    R2,??DataTable11_1  ;; 0xffffbffe
   \   0000000A   0x6AE1             LDR      R1,[R4, #+44]
    125          		
    126          	SPI1_PUSHR = SPI_PUSHR_CTAS(0) | SPI_PUSHR_EOQ_MASK |SPI_PUSHR_CTCNT_MASK | jc_data;
   \   0000000C   0xF040 0x6040      ORR      R0,R0,#0xC000000
   \   00000010   0xF041 0x5180      ORR      R1,R1,#0x10000000
   \   00000014   0x62E1             STR      R1,[R4, #+44]
   \   00000016   0x6821             LDR      R1,[R4, #+0]
   \   00000018   0x4011             ANDS     R1,R2,R1
   \   0000001A   0x6021             STR      R1,[R4, #+0]
   \   0000001C   0x6360             STR      R0,[R4, #+52]
    127          		
    128          	while((SPI1_SR & SPI_SR_TCF_MASK) == 0);
   \                     ??SD_ReadByte_0:
   \   0000001E   0x6AE0             LDR      R0,[R4, #+44]
   \   00000020   0x2800             CMP      R0,#+0
   \   00000022   0xD5FC             BPL.N    ??SD_ReadByte_0
    129          	SPI1_SR |= SPI_SR_TCF_MASK;
   \   00000024   0x6AE0             LDR      R0,[R4, #+44]
   \   00000026   0xF040 0x4000      ORR      R0,R0,#0x80000000
   \   0000002A   0x62E0             STR      R0,[R4, #+44]
    130          	
    131          #if DELAY_WaitRead_SD != 0	
    132          	SD_Delay_ReadByte();
   \   0000002C   0x.... 0x....      BL       SD_Delay_ReadByte
    133          #endif	
    134          		
    135          	dat = (byte_sd)SPI1_POPR;
   \   00000030   0x6BA0             LDR      R0,[R4, #+56]
    136          	
    137          	SPI1_MCR |= SPI_MCR_CLR_TXF_MASK | SPI_MCR_CLR_RXF_MASK;
   \   00000032   0x6821             LDR      R1,[R4, #+0]
    138          	
    139          	return dat;
   \   00000034   0xB2C0             UXTB     R0,R0
   \   00000036   0xF441 0x6140      ORR      R1,R1,#0xC00
   \   0000003A   0x6021             STR      R1,[R4, #+0]
   \   0000003C   0xBD10             POP      {R4,PC}          ;; return
    140          }
    141          
    142          
    143          /*
    144          º¯ÊýÃû³Æ£ºclose_SD
    145          º¯Êý¹¦ÄÜ£º¹Ø±ÕSD¿¨(¹Ø±ÕÎïÀí×ÜÏßµÄÍ¬Ê±ÇåÁãsd¿ÉÓÃ±êÖ¾±äÁ¿sd_yes)
    146          ±à Ð´ Õß£ºSword
    147          */

   \                                 In section .text, align 2, keep-with-next
    148          void CloseSD(void)
    149          {
    150            sd_yes = 0;
   \                     CloseSD:
   \   00000000   0x.... 0x....      LDR.W    R0,??DataTable11_2
   \   00000004   0x2100             MOVS     R1,#+0
   \   00000006   0x7001             STRB     R1,[R0, #+0]
    151            OFF_SD_CS;
   \   00000008   0x.... 0x....      LDR.W    R0,??DataTable11_3  ;; 0x400ff104
   \   0000000C   0x6801             LDR      R1,[R0, #+0]
   \   0000000E   0xF041 0x0120      ORR      R1,R1,#0x20
   \   00000012   0x6001             STR      R1,[R0, #+0]
    152            SIM_SCGC6 &= ~SIM_SCGC6_SPI1_MASK;              /* ¹Ø±ÕSPI1Ê±ÖÓ */
   \   00000014   0x.... 0x....      LDR.W    R0,??DataTable11_4  ;; 0x4004803c
   \   00000018   0x6801             LDR      R1,[R0, #+0]
   \   0000001A   0xF421 0x5100      BIC      R1,R1,#0x2000
   \   0000001E   0x6001             STR      R1,[R0, #+0]
    153          }
   \   00000020   0x4770             BX       LR               ;; return
    154          /*
    155          º¯Êý¹¦ÄÜ£ºSetSD_Low
    156          º¯ÊýÃû³Æ£ºÉè¶¨×ÜÏßÎªµÍËÙ(Ô¼Îª230kHz)
    157          ±à Ð´ Õß£ºSword
    158          */

   \                                 In section .text, align 2, keep-with-next
    159          void SetSD_Low(void)
    160          {
    161          	SPI1_CTAR0 &= (~SPI_CTAR_DBR_MASK) & (~SPI_CTAR_BR_MASK) & (~SPI_CTAR_PBR_MASK);
   \                     SetSD_Low:
   \   00000000   0x.... 0x....      LDR.W    R0,??DataTable11_5  ;; 0x4002d00c
   \   00000004   0x.... 0x....      LDR.W    R2,??DataTable11_6  ;; 0x7ffcfff0
   \   00000008   0x6801             LDR      R1,[R0, #+0]
   \   0000000A   0x4011             ANDS     R1,R2,R1
   \   0000000C   0x6001             STR      R1,[R0, #+0]
    162          	SPI1_CTAR0 |= SPI_CTAR_BR(7) | SPI_CTAR_PBR(1);
   \   0000000E   0x6801             LDR      R1,[R0, #+0]
   \   00000010   0xF441 0x3180      ORR      R1,R1,#0x10000
   \   00000014   0xF041 0x0107      ORR      R1,R1,#0x7
   \   00000018   0x6001             STR      R1,[R0, #+0]
    163          	/* DBR = 0, BR = 128, PBR = 3 ; f = f(bus)/PBR * [(1+DBR)/BR] */
    164          }
   \   0000001A   0x4770             BX       LR               ;; return
    165          /*
    166          º¯Êý¹¦ÄÜ£ºSetSD_High
    167          º¯ÊýÃû³Æ£ºÉè¶¨×ÜÏßÎª¸ßËÙ(Ô¼Îª15MHz)
    168          ±à Ð´ Õß£ºSword
    169          */

   \                                 In section .text, align 2, keep-with-next
    170          void SetSD_High(void)
    171          {
    172          	SPI1_CTAR0 &= (~SPI_CTAR_DBR_MASK) & (~SPI_CTAR_BR_MASK) & (~SPI_CTAR_PBR_MASK);
   \                     SetSD_High:
   \   00000000   0x.... 0x....      LDR.W    R0,??DataTable11_5  ;; 0x4002d00c
   \   00000004   0x.... 0x....      LDR.W    R2,??DataTable11_6  ;; 0x7ffcfff0
   \   00000008   0x6801             LDR      R1,[R0, #+0]
   \   0000000A   0x4011             ANDS     R1,R2,R1
   \   0000000C   0x6001             STR      R1,[R0, #+0]
    173            SPI1_CTAR0 |= SPI_CTAR_BR(0) | SPI_CTAR_PBR(1);
   \   0000000E   0x6801             LDR      R1,[R0, #+0]
   \   00000010   0xF441 0x3180      ORR      R1,R1,#0x10000
   \   00000014   0x6001             STR      R1,[R0, #+0]
    174          	/* DBR = 0, BR = 2, PBR = 3 ; f = f(bus)/PBR * [(1+DBR)/BR] */
    175          }
   \   00000016   0x4770             BX       LR               ;; return
    176          /*
    177          º¯ÊýÃû³Æ£ºSD_driver_Init
    178          º¯Êý¹¦ÄÜ£ºSD¿¨µÄÓ²¼þ³õÊ¼»¯
    179          ±à Ð´ Õß£ºSword
    180          */

   \                                 In section .text, align 2, keep-with-next
    181          void SD_driver_Init(void)
    182          { 
    183          	SIM_SCGC6 |= SIM_SCGC6_SPI1_MASK;              /* Ê¹ÄÜSPI1Ê±ÖÓ */
   \                     SD_driver_Init:
   \   00000000   0x.... 0x....      LDR.W    R0,??DataTable11_4  ;; 0x4004803c
   \   00000004   0x.... 0x....      LDR.W    R2,??DataTable11_7  ;; 0x801f0000
   \   00000008   0x6801             LDR      R1,[R0, #+0]
   \   0000000A   0xF441 0x5100      ORR      R1,R1,#0x2000
   \   0000000E   0x6001             STR      R1,[R0, #+0]
    184          	
    185          	PORTE_PCR0 = PORT_PCR_MUX(2) | PORT_PCR_PE_MASK | PORT_PCR_PS_MASK;
   \   00000010   0x.... 0x....      LDR.W    R0,??DataTable11_8  ;; 0x4004d000
   \   00000014   0xF240 0x2103      MOVW     R1,#+515
   \   00000018   0x6001             STR      R1,[R0, #+0]
    186          	PORTE_PCR1 = PORT_PCR_MUX(2) | PORT_PCR_PE_MASK | PORT_PCR_PS_MASK;
   \   0000001A   0x6041             STR      R1,[R0, #+4]
    187          	PORTE_PCR2 = PORT_PCR_MUX(2) | PORT_PCR_PE_MASK | PORT_PCR_PS_MASK;
   \   0000001C   0x6081             STR      R1,[R0, #+8]
    188          	PORTE_PCR3 = PORT_PCR_MUX(2) | PORT_PCR_PE_MASK;
   \   0000001E   0xF240 0x2102      MOVW     R1,#+514
   \   00000022   0x60C1             STR      R1,[R0, #+12]
    189          	                                               /* ½«PE0-PE3ÉèÎªSPI¹¦ÄÜ,PTE0-2Ê¹ÄÜÉÏÀ­µç×è,PTE3ÎªÏÂÀ­µç×è */
    190          	PORTE_PCR5 = PORT_PCR_MUX(1) | PORT_PCR_PE_MASK | PORT_PCR_PS_MASK;
   \   00000024   0xF240 0x1103      MOVW     R1,#+259
   \   00000028   0x6141             STR      R1,[R0, #+20]
    191          	GPIOE_PDDR |= (1<<5);                          /* ½«PE5ÉèÎªÆÕÍ¨IO,¿ØÖÆCS */
   \   0000002A   0x.... 0x....      LDR.W    R0,??DataTable11_3  ;; 0x400ff104
   \   0000002E   0x6901             LDR      R1,[R0, #+16]
   \   00000030   0xF041 0x0120      ORR      R1,R1,#0x20
   \   00000034   0x6101             STR      R1,[R0, #+16]
    192          	OFF_SD_CS;
   \   00000036   0x6801             LDR      R1,[R0, #+0]
   \   00000038   0xF041 0x0120      ORR      R1,R1,#0x20
   \   0000003C   0x6001             STR      R1,[R0, #+0]
    193          	
    194          	SPI1_MCR |= SPI_MCR_MSTR_MASK | SPI_MCR_PCSIS(0x1F);                 
   \   0000003E   0x.... 0x....      LDR.W    R0,??DataTable11  ;; 0x4002d000
   \   00000042   0x6801             LDR      R1,[R0, #+0]
   \   00000044   0x4311             ORRS     R1,R2,R1
   \   00000046   0x6001             STR      R1,[R0, #+0]
    195          	                                               /* ÉèÖÃÎªSPIÖ÷»ú,CSµÄÎÞÐ§×´Ì¬Îª¸ßµçÆ½ */
    196          	
    197          	SPI1_RSER |= SPI_RSER_TCF_RE_MASK | SPI_RSER_EOQF_RE_MASK;
   \   00000048   0x6B01             LDR      R1,[R0, #+48]
   \   0000004A   0xF041 0x4110      ORR      R1,R1,#0x90000000
   \   0000004E   0x6301             STR      R1,[R0, #+48]
    198          	
    199          	SPI1_CTAR0 = SPI_CTAR_FMSZ(7);                 
   \   00000050   0xF04F 0x5160      MOV      R1,#+939524096
   \   00000054   0x60C1             STR      R1,[R0, #+12]
    200          	                                               /* ÉèÖÃÒ»Ö¡´«ËÍ8bit */
    201          }
   \   00000056   0x4770             BX       LR               ;; return
    202          /**********************************************************
    203          * function:Wait_SDRdy
    204          * description:µÈ´ýSD¿¨¾ÍÐ÷(µ±ÏòSD¿¨Ð´ÈëÊý¾ÝÊ±SD¿¨½øÈëÃ¦×´Ì¬)
    205          * Input:µÈ´ýÊ±ÏÞ
    206          **********************************************************/

   \                                 In section .text, align 4, keep-with-next
    207          void Wait_SDRdy(dword_sd Limit)
    208          {
   \                     Wait_SDRdy:
   \   00000000   0xE92D 0x43F8      PUSH     {R3-R9,LR}
   \   00000004   0x4680             MOV      R8,R0
    209            dword_sd retry=0;
   \   00000006   0x2600             MOVS     R6,#+0
   \   00000008   0xF24B 0x4780      MOVW     R7,#+46208
   \   0000000C   0x.... 0x....      LDR.W    R5,??DataTable11_9  ;; 0x4005200c
   \   00000010   0xF24A 0x6902      MOVW     R9,#+42498
   \   00000014   0x.... 0x....      LDR.W    R4,??DataTable11_10
    210            while(Flag_SDRdy==0 && (++retry)<Limit) 
   \                     ??Wait_SDRdy_0:
   \   00000018   0x79E0             LDRB     R0,[R4, #+7]
   \   0000001A   0xB980             CBNZ.N   R0,??Wait_SDRdy_1
   \   0000001C   0x1C76             ADDS     R6,R6,#+1
   \   0000001E   0x4546             CMP      R6,R8
   \   00000020   0xD20D             BCS.N    ??Wait_SDRdy_1
    211            {
    212              C_WDOG();
   \   00000022   0xB672             CPSID i          
   \   00000024   0xF8A5 0x9000      STRH     R9,[R5, #+0]
   \   00000028   0x802F             STRH     R7,[R5, #+0]
   \   0000002A   0x7920             LDRB     R0,[R4, #+4]
   \   0000002C   0xB100             CBZ.N    R0,??Wait_SDRdy_2
   \   0000002E   0xB662             CPSIE i          
    213              if(SD_ReadByte(0xff)!=0)
   \                     ??Wait_SDRdy_2:
   \   00000030   0x20FF             MOVS     R0,#+255
   \   00000032   0x.... 0x....      BL       SD_ReadByte
   \   00000036   0x2800             CMP      R0,#+0
   \   00000038   0xD0EE             BEQ.N    ??Wait_SDRdy_0
    214              {
    215                Flag_SDRdy=1;
   \   0000003A   0x2001             MOVS     R0,#+1
   \   0000003C   0x71E0             STRB     R0,[R4, #+7]
    216                break;
    217              }
    218            }
    219          }
   \                     ??Wait_SDRdy_1:
   \   0000003E   0xE8BD 0x83F1      POP      {R0,R4-R9,PC}    ;; return
    220          /*********************************************************/
    221          //function:jc_sd_cmd
    222          //description:¸øSD¿¨·¢ËÍÃüÁî
    223          //input: 48¸ö×Ö½Ú£¬Ç°8Î»ÎªCMDÖ¸Áî£¬½Ó×Å32Î»ÎªµØÖ·²ÎÊý£¬
    224          //       ×îºó8Î»ÎªCRCÐ£Ñé£¨¸ÃÄ£Ê½ÔÚSPIÄ£Ê½ÏÂÎÞÐ§£©
    225          /***********************************************************/

   \                                 In section .text, align 4, keep-with-next
    226          byte_sd jc_sd_cmd(byte_sd cmd,dword_sd arg,byte_sd crc)
    227          {
   \                     jc_sd_cmd:
   \   00000000   0xE92D 0x4FF8      PUSH     {R3-R11,LR}
    228            byte_sd r1,i;
    229            word_sd retry=0;
    230           
    231            if(Flag_SDRdy == 0)
   \   00000004   0x....             LDR.N    R7,??DataTable11_10
   \   00000006   0x4680             MOV      R8,R0
   \   00000008   0x460C             MOV      R4,R1
   \   0000000A   0x4691             MOV      R9,R2
   \   0000000C   0x2500             MOVS     R5,#+0
   \   0000000E   0x....             LDR.N    R6,??DataTable11_3  ;; 0x400ff104
   \   00000010   0x79F8             LDRB     R0,[R7, #+7]
   \   00000012   0xB930             CBNZ.N   R0,??jc_sd_cmd_0
    232            {
    233              Wait_SDRdy(SD_LONG_Wait);
   \   00000014   0x....             LDR.N    R0,??DataTable11_11  ;; 0x1e8480
   \   00000016   0x.... 0x....      BL       Wait_SDRdy
    234              OFF_SD_CS;
   \   0000001A   0x6830             LDR      R0,[R6, #+0]
   \   0000001C   0xF040 0x0020      ORR      R0,R0,#0x20
   \   00000020   0x6030             STR      R0,[R6, #+0]
    235            }
    236           
    237            SD_WriteByte(0xff);
   \                     ??jc_sd_cmd_0:
   \   00000022   0x20FF             MOVS     R0,#+255
   \   00000024   0x.... 0x....      BL       SD_WriteByte
    238            ON_SD_CS;
   \   00000028   0x6870             LDR      R0,[R6, #+4]
   \   0000002A   0xF040 0x0020      ORR      R0,R0,#0x20
   \   0000002E   0x6070             STR      R0,[R6, #+4]
    239            SD_WriteByte(0xff);
   \   00000030   0x20FF             MOVS     R0,#+255
   \   00000032   0x.... 0x....      BL       SD_WriteByte
    240            SD_WriteByte(cmd|0x40);
   \   00000036   0xF048 0x0040      ORR      R0,R8,#0x40
   \   0000003A   0x.... 0x....      BL       SD_WriteByte
    241            if(flag_sdhc==0)      /************By Sword************/  
   \   0000003E   0x7978             LDRB     R0,[R7, #+5]
   \   00000040   0xB900             CBNZ.N   R0,??jc_sd_cmd_1
    242              arg=arg << 9;  //¶ÔÓÚ·ÇsdhcµÄsd¿¨,¡¢µØÖ·ÊÇÒÔ×Ö½ÚÎªµ¥Î»µÄ
   \   00000042   0x0264             LSLS     R4,R4,#+9
    243          //¼æÈÝsdhcºÍsd1.0µÄÉèÖÃ   
    244            SD_WriteByte((byte_sd)((arg>>24)&0x0000FF)); //´«ËÍ32Î»µØÖ·
   \                     ??jc_sd_cmd_1:
   \   00000044   0x0E20             LSRS     R0,R4,#+24
   \   00000046   0x.... 0x....      BL       SD_WriteByte
    245            SD_WriteByte((byte_sd)((arg>>16)&0x0000FF));
   \   0000004A   0x0C20             LSRS     R0,R4,#+16
   \   0000004C   0xB2C0             UXTB     R0,R0
   \   0000004E   0x.... 0x....      BL       SD_WriteByte
    246            SD_WriteByte((byte_sd)((arg>>8)&0x0000FF));
   \   00000052   0x0A20             LSRS     R0,R4,#+8
   \   00000054   0xB2C0             UXTB     R0,R0
   \   00000056   0x.... 0x....      BL       SD_WriteByte
    247            SD_WriteByte((byte_sd)(arg&0x0000FF));
   \   0000005A   0xB2E0             UXTB     R0,R4
   \   0000005C   0x.... 0x....      BL       SD_WriteByte
    248            SD_WriteByte(crc); 
   \   00000060   0x4648             MOV      R0,R9
   \   00000062   0x.... 0x....      BL       SD_WriteByte
   \   00000066   0xF24B 0x4480      MOVW     R4,#+46208
   \   0000006A   0x.... 0x....      LDR.W    R9,??DataTable11_9  ;; 0x4005200c
   \   0000006E   0xF24A 0x6A02      MOVW     R10,#+42498
    249            do
    250            {
    251            	r1=SD_ReadByte(0xff);
   \                     ??jc_sd_cmd_2:
   \   00000072   0x20FF             MOVS     R0,#+255
   \   00000074   0x.... 0x....      BL       SD_ReadByte
   \   00000078   0x4683             MOV      R11,R0
    252              retry++;
   \   0000007A   0x1C6D             ADDS     R5,R5,#+1
    253              C_WDOG(); //Çå¿ªÃÅ¹· 
   \   0000007C   0xB672             CPSID i          
   \   0000007E   0xF8A9 0xA000      STRH     R10,[R9, #+0]
   \   00000082   0xF8A9 0x4000      STRH     R4,[R9, #+0]
   \   00000086   0x7938             LDRB     R0,[R7, #+4]
   \   00000088   0xB100             CBZ.N    R0,??jc_sd_cmd_3
   \   0000008A   0xB662             CPSIE i          
    254              if(retry==250) 
   \                     ??jc_sd_cmd_3:
   \   0000008C   0xB2AD             UXTH     R5,R5
   \   0000008E   0x2DFA             CMP      R5,#+250
   \   00000090   0xD002             BEQ.N    ??jc_sd_cmd_4
    255              {
    256                retry=0;
    257                break;
    258              }
    259                 
    260            }while(r1==0xff);
   \   00000092   0xF1BB 0x0FFF      CMP      R11,#+255
   \   00000096   0xD0EC             BEQ.N    ??jc_sd_cmd_2
    261            if(cmd==8||cmd==58)   /************By Sword************/  
   \                     ??jc_sd_cmd_4:
   \   00000098   0xF1B8 0x0F08      CMP      R8,#+8
   \   0000009C   0xBF18             IT       NE 
   \   0000009E   0xF1B8 0x0F3A      CMPNE    R8,#+58
   \   000000A2   0xD10F             BNE.N    ??jc_sd_cmd_5
    262              for(i=0;i<4;i++) resp_sd[i]=SD_ReadByte(0xff);   
   \   000000A4   0x20FF             MOVS     R0,#+255
   \   000000A6   0x.... 0x....      BL       SD_ReadByte
   \   000000AA   0x7038             STRB     R0,[R7, #+0]
   \   000000AC   0x20FF             MOVS     R0,#+255
   \   000000AE   0x.... 0x....      BL       SD_ReadByte
   \   000000B2   0x7078             STRB     R0,[R7, #+1]
   \   000000B4   0x20FF             MOVS     R0,#+255
   \   000000B6   0x.... 0x....      BL       SD_ReadByte
   \   000000BA   0x70B8             STRB     R0,[R7, #+2]
   \   000000BC   0x20FF             MOVS     R0,#+255
   \   000000BE   0x.... 0x....      BL       SD_ReadByte
   \   000000C2   0x70F8             STRB     R0,[R7, #+3]
    263          //¶ÁÈ¡sdhc¿¨µÄÏà¹ØÐÅÏ¢ 
    264            OFF_SD_CS;
   \                     ??jc_sd_cmd_5:
   \   000000C4   0x6830             LDR      R0,[R6, #+0]
   \   000000C6   0xF040 0x0020      ORR      R0,R0,#0x20
   \   000000CA   0x6030             STR      R0,[R6, #+0]
    265            SD_WriteByte(0xff);
   \   000000CC   0x20FF             MOVS     R0,#+255
   \   000000CE   0x.... 0x....      BL       SD_WriteByte
    266            return(r1);
   \   000000D2   0x4658             MOV      R0,R11
   \   000000D4   0xE8BD 0x8FF2      POP      {R1,R4-R11,PC}   ;; return
    267          }
    268          /*********************************************************/
    269          //function: sd_init
    270          //description:sd¿¨³õÊ¼»¯º¯Êý
    271          /***********************************************************/

   \                                 In section .text, align 4, keep-with-next
    272          byte_sd sd_init(void)
    273          {
   \                     sd_init:
   \   00000000   0xE92D 0x41F0      PUSH     {R4-R8,LR}
    274            byte_sd i=0,r1=0;
    275            word_sd retry=0;
   \   00000004   0x2500             MOVS     R5,#+0
    276            for(i=0;i<10;i++)
   \   00000006   0x240A             MOVS     R4,#+10
    277              SD_WriteByte(0xFF);//µÈ´ý74¸öÊ±ÖÓÖÜÆÚ£¬sd¹¤×÷µçÑ¹ÉýÖÁÕý³£Öµ
   \                     ??sd_init_0:
   \   00000008   0x20FF             MOVS     R0,#+255
   \   0000000A   0x.... 0x....      BL       SD_WriteByte
   \   0000000E   0x1E64             SUBS     R4,R4,#+1
   \   00000010   0xD1FA             BNE.N    ??sd_init_0
    278            
    279            flag_sdhc=1; //ÏÈÄ¬ÈÏÎªsdhc¿¨
   \   00000012   0x....             LDR.N    R4,??DataTable11_10
   \   00000014   0x2001             MOVS     R0,#+1
   \   00000016   0x7160             STRB     R0,[R4, #+5]
   \   00000018   0xF24B 0x4680      MOVW     R6,#+46208
   \   0000001C   0x....             LDR.N    R7,??DataTable11_9  ;; 0x4005200c
   \   0000001E   0xF24A 0x6802      MOVW     R8,#+42498
    280            
    281            do
    282             {
    283                //·¢ËÍCMD0£¬ÈÃSD¿¨½øÈëIDLE×´Ì¬
    284                r1 = jc_sd_cmd(0,0,0x95);
   \                     ??sd_init_1:
   \   00000022   0x2295             MOVS     R2,#+149
   \   00000024   0x2100             MOVS     R1,#+0
   \   00000026   0x2000             MOVS     R0,#+0
   \   00000028   0x.... 0x....      BL       jc_sd_cmd
    285                retry++;
   \   0000002C   0x1C6D             ADDS     R5,R5,#+1
    286                C_WDOG(); //Çå¿ªÃÅ¹·
   \   0000002E   0xB672             CPSID i          
   \   00000030   0xF8A7 0x8000      STRH     R8,[R7, #+0]
   \   00000034   0x803E             STRH     R6,[R7, #+0]
   \   00000036   0x7921             LDRB     R1,[R4, #+4]
   \   00000038   0xB101             CBZ.N    R1,??sd_init_2
   \   0000003A   0xB662             CPSIE i          
    287             } while ((r1 != 0x01) && (retry < 100));
   \                     ??sd_init_2:
   \   0000003C   0x2801             CMP      R0,#+1
   \   0000003E   0xD002             BEQ.N    ??sd_init_3
   \   00000040   0xB2AD             UXTH     R5,R5
   \   00000042   0x2D64             CMP      R5,#+100
   \   00000044   0xD3ED             BCC.N    ??sd_init_1
    288            if (retry==100) 
   \                     ??sd_init_3:
   \   00000046   0xB2AD             UXTH     R5,R5
   \   00000048   0x2D64             CMP      R5,#+100
   \   0000004A   0xBF04             ITT      EQ 
   \   0000004C   0x2001             MOVEQ    R0,#+1
   \   0000004E   0x71A0             STRBEQ   R0,[R4, #+6]
    289             {          //·¢ËÍCMD0³ö´í
    290               flag_err_sd=SDERR_CMD0;
    291               return 1; 
   \   00000050   0xD03B             BEQ.N    ??sd_init_4
    292             }
    293            retry=0;
   \   00000052   0x2500             MOVS     R5,#+0
    294           
    295            //³õ²½È·ÈÏÊÇSDHC»¹ÊÇSD1.0
    296            r1=jc_sd_cmd(8,0x1aa,0x87);
    297            if(r1!=0x01||resp_sd[2]!=1||resp_sd[3]!=170) flag_sdhc=0;
   \   00000054   0x2287             MOVS     R2,#+135
   \   00000056   0xF44F 0x71D5      MOV      R1,#+426
   \   0000005A   0x2008             MOVS     R0,#+8
   \   0000005C   0x.... 0x....      BL       jc_sd_cmd
   \   00000060   0x2801             CMP      R0,#+1
   \   00000062   0xBF01             ITTTT    EQ 
   \   00000064   0x78A0             LDRBEQ   R0,[R4, #+2]
   \   00000066   0x2801             CMPEQ    R0,#+1
   \   00000068   0x78E0             LDRBEQ   R0,[R4, #+3]
   \   0000006A   0x28AA             CMPEQ    R0,#+170
   \   0000006C   0xD000             BEQ.N    ??sd_init_5
   \   0000006E   0x7165             STRB     R5,[R4, #+5]
    298           /************By Sword************/ 
    299             
    300            retry=0;
    301            //·¢ËÍcmd55+acmd41Ê¹sd¿¨¹¤×÷ÔÚspiÄ£Ê½
    302            do
    303             {
    304                r1=jc_sd_cmd(55,0,0xff);
   \                     ??sd_init_5:
   \   00000070   0x22FF             MOVS     R2,#+255
   \   00000072   0x2100             MOVS     R1,#+0
   \   00000074   0x2037             MOVS     R0,#+55
   \   00000076   0x.... 0x....      BL       jc_sd_cmd
    305                if(r1==0x01)
   \   0000007A   0x2801             CMP      R0,#+1
   \   0000007C   0xD105             BNE.N    ??sd_init_6
    306                  r1=jc_sd_cmd(41,((dword_sd)flag_sdhc)<<30,0xff);
   \   0000007E   0x7960             LDRB     R0,[R4, #+5]
   \   00000080   0x22FF             MOVS     R2,#+255
   \   00000082   0x0781             LSLS     R1,R0,#+30
   \   00000084   0x2029             MOVS     R0,#+41
   \   00000086   0x.... 0x....      BL       jc_sd_cmd
    307                retry++;
   \                     ??sd_init_6:
   \   0000008A   0x1C6D             ADDS     R5,R5,#+1
    308                C_WDOG(); //Çå¿ªÃÅ¹· 
   \   0000008C   0xB672             CPSID i          
   \   0000008E   0xF8A7 0x8000      STRH     R8,[R7, #+0]
   \   00000092   0x803E             STRH     R6,[R7, #+0]
   \   00000094   0x7921             LDRB     R1,[R4, #+4]
   \   00000096   0xB101             CBZ.N    R1,??sd_init_7
   \   00000098   0xB662             CPSIE i          
    309             } while ((r1 != 0x00) && (retry < 100));
   \                     ??sd_init_7:
   \   0000009A   0xB110             CBZ.N    R0,??sd_init_8
   \   0000009C   0xB2AD             UXTH     R5,R5
   \   0000009E   0x2D64             CMP      R5,#+100
   \   000000A0   0xD3E6             BCC.N    ??sd_init_5
    310            
    311            if(retry>=100)
   \                     ??sd_init_8:
   \   000000A2   0xB2AD             UXTH     R5,R5
   \   000000A4   0x2D64             CMP      R5,#+100
   \   000000A6   0xBF22             ITTT     CS 
   \   000000A8   0x2002             MOVCS    R0,#+2
   \   000000AA   0x71A0             STRBCS   R0,[R4, #+6]
   \   000000AC   0x2001             MOVCS    R0,#+1
    312             {       //·¢ËÍACMD41Ö¸ÁîÊ±³ö´í
    313               flag_err_sd=SDERR_ACMD41; 
    314               return 1;
   \   000000AE   0xD20C             BCS.N    ??sd_init_4
    315             }
    316             
    317            if(flag_sdhc) 
   \   000000B0   0x7960             LDRB     R0,[R4, #+5]
   \   000000B2   0xB148             CBZ.N    R0,??sd_init_9
    318             {
    319               (void)jc_sd_cmd(58,0,0xff);      //×îÖÕÈ·ÈÏÊÇ·ñÊÇsdhc¿¨
   \   000000B4   0x22FF             MOVS     R2,#+255
   \   000000B6   0x2100             MOVS     R1,#+0
   \   000000B8   0x203A             MOVS     R0,#+58
   \   000000BA   0x.... 0x....      BL       jc_sd_cmd
    320               if((resp_sd[0]&0x40)==0) flag_sdhc=0; 
   \   000000BE   0x7820             LDRB     R0,[R4, #+0]
   \   000000C0   0x0640             LSLS     R0,R0,#+25
   \   000000C2   0xBF5C             ITT      PL 
   \   000000C4   0x2000             MOVPL    R0,#+0
   \   000000C6   0x7160             STRBPL   R0,[R4, #+5]
    321             }
    322           /************By Sword************/   
    323          
    324            return 0;
   \                     ??sd_init_9:
   \   000000C8   0x2000             MOVS     R0,#+0
   \                     ??sd_init_4:
   \   000000CA   0xE8BD 0x81F0      POP      {R4-R8,PC}       ;; return
    325          }
    326          /*********************************************************/
    327          //function:sd_rdata
    328          //description:´Ósd¿¨¶ÁÈ¡Ö¸¶¨³¤¶ÈÊý¾Ý
    329          /***********************************************************/

   \                                 In section .text, align 4, keep-with-next
    330          byte_sd sd_rdata(byte_sd * data,word_sd len)
    331          {
   \                     sd_rdata:
   \   00000000   0xE92D 0x43F8      PUSH     {R3-R9,LR}
    332            byte_sd r1=0;
    333            word_sd retry=0;
    334            /************By Sword************/  
    335           //Ô­ÏÈretryÎªbyte_sdÐÍ  
    336            ON_SD_CS;
   \   00000004   0x....             LDR.N    R6,??DataTable11_3  ;; 0x400ff104
   \   00000006   0x4680             MOV      R8,R0
   \   00000008   0x6870             LDR      R0,[R6, #+4]
   \   0000000A   0x460D             MOV      R5,R1
   \   0000000C   0xF040 0x0020      ORR      R0,R0,#0x20
   \   00000010   0x2700             MOVS     R7,#+0
   \   00000012   0x6070             STR      R0,[R6, #+4]
    337            do
    338            {
    339              r1=SD_ReadByte(0xff);
   \                     ??sd_rdata_0:
   \   00000014   0x20FF             MOVS     R0,#+255
   \   00000016   0x.... 0x....      BL       SD_ReadByte
    340              retry++;
   \   0000001A   0x1C7F             ADDS     R7,R7,#+1
    341            }while(r1!=0xfe&&retry<500);
   \   0000001C   0x28FE             CMP      R0,#+254
   \   0000001E   0xD004             BEQ.N    ??sd_rdata_1
   \   00000020   0xF44F 0x71FA      MOV      R1,#+500
   \   00000024   0xB2BF             UXTH     R7,R7
   \   00000026   0x428F             CMP      R7,R1
   \   00000028   0xD3F4             BCC.N    ??sd_rdata_0
    342            if(retry>=500) return r1;
   \                     ??sd_rdata_1:
   \   0000002A   0xF44F 0x71FA      MOV      R1,#+500
   \   0000002E   0xB2BF             UXTH     R7,R7
   \   00000030   0x428F             CMP      R7,R1
   \   00000032   0xD224             BCS.N    ??sd_rdata_2
   \   00000034   0xB1AD             CBZ.N    R5,??sd_rdata_3
   \   00000036   0xF24B 0x4780      MOVW     R7,#+46208
   \   0000003A   0x....             LDR.N    R4,??DataTable11_9  ;; 0x4005200c
   \   0000003C   0xF24A 0x6902      MOVW     R9,#+42498
   \                     ??sd_rdata_4:
   \   00000040   0x1E6D             SUBS     R5,R5,#+1
    343          /************By Sword************/  
    344           //Ô­ÏÈÎªretry<200£¬Ð¡ÓÚ200µÄÊ±¼äÌ«¶Ì,ºÜ¶àµÍ¶ËµÄ¿¨¶Á²»³öÀ´
    345           //£¡£¡£¡£¡£¡£¡£¡£¡£¡£¡£¡  
    346            retry=0;
    347            while(len--)
    348            {
    349            	C_WDOG(); //Çå¿ªÃÅ¹· 
   \   00000042   0xB672             CPSID i          
   \   00000044   0xF8A4 0x9000      STRH     R9,[R4, #+0]
   \   00000048   0x....             LDR.N    R0,??DataTable11_10
   \   0000004A   0x8027             STRH     R7,[R4, #+0]
   \   0000004C   0x7900             LDRB     R0,[R0, #+4]
   \   0000004E   0xB100             CBZ.N    R0,??sd_rdata_5
   \   00000050   0xB662             CPSIE i          
    350              *data=SD_ReadByte(0xff);
   \                     ??sd_rdata_5:
   \   00000052   0x20FF             MOVS     R0,#+255
   \   00000054   0x.... 0x....      BL       SD_ReadByte
    351              data++;
    352            }
   \   00000058   0xB2AD             UXTH     R5,R5
   \   0000005A   0xF808 0x0B01      STRB     R0,[R8], #+1
   \   0000005E   0x2D00             CMP      R5,#+0
   \   00000060   0xD1EE             BNE.N    ??sd_rdata_4
    353            SD_WriteByte(0xff);    //ÕâÁ½¾äÊÇ¶ÁÎ±Ö¸Áî
   \                     ??sd_rdata_3:
   \   00000062   0x20FF             MOVS     R0,#+255
   \   00000064   0x.... 0x....      BL       SD_WriteByte
    354            SD_WriteByte(0xff);
   \   00000068   0x20FF             MOVS     R0,#+255
   \   0000006A   0x.... 0x....      BL       SD_WriteByte
    355            OFF_SD_CS;
   \   0000006E   0x6830             LDR      R0,[R6, #+0]
   \   00000070   0xF040 0x0020      ORR      R0,R0,#0x20
   \   00000074   0x6030             STR      R0,[R6, #+0]
    356            SD_WriteByte(0xff);
   \   00000076   0x20FF             MOVS     R0,#+255
   \   00000078   0x.... 0x....      BL       SD_WriteByte
    357            return 0;
   \   0000007C   0x2000             MOVS     R0,#+0
   \                     ??sd_rdata_2:
   \   0000007E   0xE8BD 0x83F2      POP      {R1,R4-R9,PC}    ;; return
    358          }
    359          /*********************************************************/
    360          //function:sd_readsingleblock
    361          //description:sd¿¨¶ÁÈ¡µ¥¿éÊý¾Ý£¨Ò»°ãÎª512×Ö½Ú£©
    362          //input: data   ´æ·ÅÊý¾ÝµÄÊý×éÊ×µØÖ·
    363          //       sector ÉÈÇøºÅ£¨×¢ÒâÎªÎïÀíÉÈÇøºÅ£¡£¡£©
    364          /***********************************************************/

   \                                 In section .text, align 2, keep-with-next
    365          byte_sd sd_readsingleblock(byte_sd * data,dword_sd sector)
    366          {
   \                     sd_readsingleblock:
   \   00000000   0xB570             PUSH     {R4-R6,LR}
   \   00000002   0x4604             MOV      R4,R0
    367             byte_sd r1=0;
    368             word_sd retry=0;
    369             
    370             if(Flag_SDRdy == 0)
   \   00000004   0x....             LDR.N    R0,??DataTable11_10
   \   00000006   0x460D             MOV      R5,R1
   \   00000008   0x2600             MOVS     R6,#+0
   \   0000000A   0x79C0             LDRB     R0,[R0, #+7]
   \   0000000C   0xB938             CBNZ.N   R0,??sd_readsingleblock_0
    371             {
    372               Wait_SDRdy(SD_LONG_Wait);
   \   0000000E   0x....             LDR.N    R0,??DataTable11_11  ;; 0x1e8480
   \   00000010   0x.... 0x....      BL       Wait_SDRdy
    373               OFF_SD_CS;
   \   00000014   0x....             LDR.N    R0,??DataTable11_3  ;; 0x400ff104
   \   00000016   0x6801             LDR      R1,[R0, #+0]
   \   00000018   0xF041 0x0120      ORR      R1,R1,#0x20
   \   0000001C   0x6001             STR      R1,[R0, #+0]
    374             }
    375             
    376           /************By Sword************/  
    377           //Ô­ÏÈretryÎªbyte_sdÐÍ  
    378             do
    379             {
    380              r1=jc_sd_cmd(17,sector,0);
   \                     ??sd_readsingleblock_0:
   \   0000001E   0x2200             MOVS     R2,#+0
   \   00000020   0x4629             MOV      R1,R5
   \   00000022   0x2011             MOVS     R0,#+17
   \   00000024   0x.... 0x....      BL       jc_sd_cmd
    381              retry++;
   \   00000028   0x1C76             ADDS     R6,R6,#+1
    382             } while(r1!=0&&retry<200);
   \   0000002A   0xB110             CBZ.N    R0,??sd_readsingleblock_1
   \   0000002C   0xB2B6             UXTH     R6,R6
   \   0000002E   0x2EC8             CMP      R6,#+200
   \   00000030   0xD3F5             BCC.N    ??sd_readsingleblock_0
    383             if(retry>=200) return r1;
   \                     ??sd_readsingleblock_1:
   \   00000032   0xB2B6             UXTH     R6,R6
   \   00000034   0x2EC8             CMP      R6,#+200
   \   00000036   0xD205             BCS.N    ??sd_readsingleblock_2
    384           /************By Sword************/  
    385           //BUG£¡£¡£¡£¡£¬Ô­À´ÊÇr1==200 £¡£¡£¡ 
    386             retry=0;
    387             r1=sd_rdata(data,512);
   \   00000038   0x4620             MOV      R0,R4
   \   0000003A   0xE8BD 0x4070      POP      {R4-R6,LR}
   \   0000003E   0xF44F 0x7100      MOV      R1,#+512
   \   00000042   0x....             B.N      sd_rdata
   \                     ??sd_readsingleblock_2:
   \   00000044   0xBD70             POP      {R4-R6,PC}       ;; return
    388             if(r1!=0) return r1;
    389             else return 0; 
    390          } 
    391          /*********************************************************/
    392          //function:sd_writesingleblock
    393          //description:sd¿¨Ð´µ¥¿éÊý¾Ý
    394          //input:Ô¤ÁôramÇøµÄÖ¸Õë£¬ÉÈÇøºÅ£¨×¢ÒâÎªÎïÀíÉÈÇøºÅ£©
    395          /***********************************************************/

   \                                 In section .text, align 4, keep-with-next
    396          byte_sd sd_writesingleblock(byte_sd *data,dword_sd sector)
    397          {
   \                     sd_writesingleblock:
   \   00000000   0xE92D 0x47F0      PUSH     {R4-R10,LR}
    398          	byte_sd r1=0;
    399          	dword_sd i=0;
    400            
    401            if(Flag_SDRdy == 0)
   \   00000004   0x....             LDR.N    R5,??DataTable11_10
   \   00000006   0x4604             MOV      R4,R0
   \   00000008   0x460F             MOV      R7,R1
   \   0000000A   0x79E8             LDRB     R0,[R5, #+7]
   \   0000000C   0xB938             CBNZ.N   R0,??sd_writesingleblock_0
    402            {
    403              Wait_SDRdy(SD_LONG_Wait);
   \   0000000E   0x....             LDR.N    R0,??DataTable11_11  ;; 0x1e8480
   \   00000010   0x.... 0x....      BL       Wait_SDRdy
    404              OFF_SD_CS;
   \   00000014   0x....             LDR.N    R6,??DataTable11_3  ;; 0x400ff104
   \   00000016   0x6830             LDR      R0,[R6, #+0]
   \   00000018   0xF040 0x0020      ORR      R0,R0,#0x20
   \   0000001C   0x6030             STR      R0,[R6, #+0]
    405            }
    406            
    407            r1=jc_sd_cmd(24,sector,0);
   \                     ??sd_writesingleblock_0:
   \   0000001E   0x2200             MOVS     R2,#+0
   \   00000020   0x4639             MOV      R1,R7
   \   00000022   0x2018             MOVS     R0,#+24
   \   00000024   0x.... 0x....      BL       jc_sd_cmd
    408            
    409            if(r1!=0) return r1;
   \   00000028   0x2800             CMP      R0,#+0
   \   0000002A   0xD13A             BNE.N    ??sd_writesingleblock_1
    410            ON_SD_CS;
   \   0000002C   0x....             LDR.N    R6,??DataTable11_3  ;; 0x400ff104
   \   0000002E   0x6870             LDR      R0,[R6, #+4]
   \   00000030   0xF040 0x0020      ORR      R0,R0,#0x20
   \   00000034   0x6070             STR      R0,[R6, #+4]
    411            SD_WriteByte(0xff);//ÏÈ·¢Èý¸ö¿ÕÊý¾ÝµÈ´ýsd¿¨×¼±¸ºÃ
   \   00000036   0x20FF             MOVS     R0,#+255
   \   00000038   0x.... 0x....      BL       SD_WriteByte
    412            SD_WriteByte(0xff);
   \   0000003C   0x20FF             MOVS     R0,#+255
   \   0000003E   0x.... 0x....      BL       SD_WriteByte
    413            SD_WriteByte(0xff);
   \   00000042   0x20FF             MOVS     R0,#+255
   \   00000044   0x.... 0x....      BL       SD_WriteByte
    414            SD_WriteByte(0xfe);//·¢ËÍÆðÊ¼ÁîÅÆ
   \   00000048   0x20FE             MOVS     R0,#+254
   \   0000004A   0x.... 0x....      BL       SD_WriteByte
    415            for(i=0;i<512;i++)
   \   0000004E   0xF44F 0x7700      MOV      R7,#+512
   \   00000052   0xF24B 0x4880      MOVW     R8,#+46208
   \   00000056   0x.... 0x....      LDR.W    R9,??DataTable11_9  ;; 0x4005200c
   \   0000005A   0xF24A 0x6A02      MOVW     R10,#+42498
    416            {
    417              C_WDOG(); //Çå¿ªÃÅ¹· 
   \                     ??sd_writesingleblock_2:
   \   0000005E   0xB672             CPSID i          
   \   00000060   0xF8A9 0xA000      STRH     R10,[R9, #+0]
   \   00000064   0xF8A9 0x8000      STRH     R8,[R9, #+0]
   \   00000068   0x7928             LDRB     R0,[R5, #+4]
   \   0000006A   0xB100             CBZ.N    R0,??sd_writesingleblock_3
   \   0000006C   0xB662             CPSIE i          
    418              SD_WriteByte(*data++);
   \                     ??sd_writesingleblock_3:
   \   0000006E   0xF814 0x0B01      LDRB     R0,[R4], #+1
   \   00000072   0x.... 0x....      BL       SD_WriteByte
    419            } 
   \   00000076   0x1E7F             SUBS     R7,R7,#+1
   \   00000078   0xD1F1             BNE.N    ??sd_writesingleblock_2
    420              
    421            SD_WriteByte(0xff);
   \   0000007A   0x20FF             MOVS     R0,#+255
   \   0000007C   0x.... 0x....      BL       SD_WriteByte
    422            SD_WriteByte(0xff);
   \   00000080   0x20FF             MOVS     R0,#+255
   \   00000082   0x.... 0x....      BL       SD_WriteByte
    423            r1=SD_ReadByte(0xff);
   \   00000086   0x20FF             MOVS     R0,#+255
   \   00000088   0x.... 0x....      BL       SD_ReadByte
    424            if((r1&0x1f)!=0x05) 
   \   0000008C   0xF000 0x011F      AND      R1,R0,#0x1F
   \   00000090   0x2905             CMP      R1,#+5
   \   00000092   0xBF1E             ITTT     NE 
   \   00000094   0x6831             LDRNE    R1,[R6, #+0]
   \   00000096   0xF041 0x0120      ORRNE    R1,R1,#0x20
   \   0000009A   0x6031             STRNE    R1,[R6, #+0]
    425            {
    426              OFF_SD_CS;
    427              return (r1 | 0);
   \   0000009C   0xBF04             ITT      EQ 
   \   0000009E   0x2000             MOVEQ    R0,#+0
   \   000000A0   0x71E8             STRBEQ   R0,[R5, #+7]
    428            }
    429            else
    430            { //·¢ËÍÍêÊý¾Ýºó²¢²»µÈ´ýSD¿¨Ð´ºÃ,¶øÊÇÔÚÏÂÒ»´ÎÐ´Êý¾ÝÊ±ÔÙµÈ´ý
    431              Flag_SDRdy=0;
    432              return 0; 
   \                     ??sd_writesingleblock_1:
   \   000000A2   0xE8BD 0x87F0      POP      {R4-R10,PC}      ;; return
    433            }
    434          }

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11:
   \   00000000   0x4002D000         DC32     0x4002d000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_1:
   \   00000000   0xFFFFBFFE         DC32     0xffffbffe

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_2:
   \   00000000   0x........         DC32     sd_yes

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_3:
   \   00000000   0x400FF104         DC32     0x400ff104

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_4:
   \   00000000   0x4004803C         DC32     0x4004803c

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_5:
   \   00000000   0x4002D00C         DC32     0x4002d00c

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_6:
   \   00000000   0x7FFCFFF0         DC32     0x7ffcfff0

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_7:
   \   00000000   0x801F0000         DC32     0x801f0000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_8:
   \   00000000   0x4004D000         DC32     0x4004d000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_9:
   \   00000000   0x4005200C         DC32     0x4005200c

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_10:
   \   00000000   0x........         DC32     resp_sd

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable11_11:
   \   00000000   0x001E8480         DC32     0x1e8480
    435          
    436          #endif    

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
        0  CloseSD
        0  SD_Delay_ReadByte
        8  SD_ReadByte
              8 -> SD_Delay_ReadByte
        0  SD_WriteByte
        0  SD_driver_Init
        0  SetSD_High
        0  SetSD_Low
       32  Wait_SDRdy
             32 -> SD_ReadByte
       40  jc_sd_cmd
             40 -> SD_ReadByte
             40 -> SD_WriteByte
             40 -> Wait_SDRdy
       24  sd_init
             24 -> SD_WriteByte
             24 -> jc_sd_cmd
       32  sd_rdata
             32 -> SD_ReadByte
             32 -> SD_WriteByte
       16  sd_readsingleblock
             16 -> Wait_SDRdy
             16 -> jc_sd_cmd
              0 -> sd_rdata
       32  sd_writesingleblock
             32 -> SD_ReadByte
             32 -> SD_WriteByte
             32 -> Wait_SDRdy
             32 -> jc_sd_cmd


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable11
       4  ??DataTable11_1
       4  ??DataTable11_10
       4  ??DataTable11_11
       4  ??DataTable11_2
       4  ??DataTable11_3
       4  ??DataTable11_4
       4  ??DataTable11_5
       4  ??DataTable11_6
       4  ??DataTable11_7
       4  ??DataTable11_8
       4  ??DataTable11_9
      34  CloseSD
     102  SD_Delay_ReadByte
      62  SD_ReadByte
      52  SD_WriteByte
      88  SD_driver_Init
      24  SetSD_High
      28  SetSD_Low
      66  Wait_SDRdy
       1  flag_test_sd
     216  jc_sd_cmd
       8  resp_sd
          sd_initover
          flag_sdhc
          flag_err_sd
          Flag_SDRdy
     206  sd_init
     130  sd_rdata
      70  sd_readsingleblock
     166  sd_writesingleblock
       1  sd_yes

 
    10 bytes in section .bss
 1 292 bytes in section .text
 
 1 292 bytes of CODE memory
    10 bytes of DATA memory

Errors: none
Warnings: none
